#!/data/data/com.termux/files/usr/bin/sh

if [ "$#" -lt 1 ] || [ "$1" = "-h" ] || [ "$1" = "--help" ] || [ "${1#-}" != "$1" ]; then
  if [ "$#" -gt 0 ] && [ "${1#-}" != "$1" ]; then
    echo "Error: missing sandbox name before flags." >&2
  fi
  echo "Usage: asb <name> [termux-sandbox options]" >&2
  echo "Example: asb 0   # launches agent-sandbox-0" >&2
  echo "Flags: --workdir-path (print workdir) | --rootfs-path (print rootfs)" >&2
  exit 1
fi

SCRIPT_DIR=$(cd "$(dirname "$0")" && pwd)

SHORT_NAME="$1"
shift

case "$SHORT_NAME" in
  agent-sandbox-*)
    SANDBOX_NAME="$SHORT_NAME"
    ;;
  *)
    SANDBOX_NAME="agent-sandbox-$SHORT_NAME"
    ;;
esac

WORKDIR="$HOME/agent-work-${SANDBOX_NAME#agent-sandbox-}"
ROOTFS="$HOME/sandboxes/$SANDBOX_NAME"

for arg in "$@"; do
  case "$arg" in
    --workdir-path)
      printf "%s\n" "$WORKDIR"
      exit 0
      ;;
    --rootfs-path)
      printf "%s\n" "$ROOTFS"
      exit 0
      ;;
  esac
done

if [ ! -e "$ROOTFS/bin/bash" ]; then
  if [ ! -t 0 ]; then
    echo "Error: sandbox '$SANDBOX_NAME' does not exist and input is not interactive." >&2
    echo "Missing: $ROOTFS/bin/bash" >&2
    exit 1
  fi
  printf "Sandbox '%s' does not exist (missing %s). Create it? [y/N] " "$SANDBOX_NAME" "$ROOTFS/bin/bash" >&2
  read -r reply
  case "$reply" in
    y|Y|yes|YES)
      ;;
    *)
      echo "Aborted." >&2
      exit 1
      ;;
  esac
fi

if [ -x "$SCRIPT_DIR/termux-sandbox" ]; then
  exec "$SCRIPT_DIR/termux-sandbox" "$SANDBOX_NAME" "$@"
fi

exec termux-sandbox "$SANDBOX_NAME" "$@"
