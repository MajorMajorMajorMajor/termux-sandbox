#!/data/data/com.termux/files/usr/bin/sh
set -eu

if [ "$#" -lt 1 ] || [ "$1" = "-h" ] || [ "$1" = "--help" ] || [ "${1#-}" != "$1" ]; then
  if [ "$#" -gt 0 ] && [ "${1#-}" != "$1" ]; then
    echo "Error: missing sandbox name before flags." >&2
  fi
  echo "Usage: asb <name> [termux-sandbox options]" >&2
  echo "Example: asb 0   # launches agent-sandbox-0" >&2
  echo "Flags: --workdir-path (print workdir) | --rootfs-path (print rootfs) | --edit-config" >&2
  exit 1
fi

SCRIPT_DIR=$(cd "$(dirname "$0")" && pwd)

SHORT_NAME="$1"
shift

case "$SHORT_NAME" in
  agent-sandbox-*)
    SANDBOX_NAME="$SHORT_NAME"
    ;;
  *)
    SANDBOX_NAME="agent-sandbox-$SHORT_NAME"
    ;;
esac

WORKDIR="$HOME/agent-work-${SANDBOX_NAME#agent-sandbox-}"
ROOTFS="$HOME/sandboxes/$SANDBOX_NAME"

CONFIG_DIR="$HOME/.termux-sandbox/configs"
CONFIG_FILE="$CONFIG_DIR/$SANDBOX_NAME.conf"

prompt_storage_preset() {
  cat >&2 <<'EOF'
Choose Android storage preset:
  1) none (default)
  2) downloads (0/Downloads)
  3) docs (0/Documents)
  4) media (0/DCIM, 0/Pictures, 0/Movies, 0/Music)
  5) full (/storage/emulated)
EOF
  printf "Preset [1-5, default 1]: " >&2
  read -r storage_preset
  case "$storage_preset" in
    ""|1|none) echo "none" ;;
    2|downloads) echo "downloads" ;;
    3|docs|documents) echo "docs" ;;
    4|media) echo "media" ;;
    5|full) echo "full" ;;
    *)
      echo "Error: unknown preset '$storage_preset'." >&2
      return 1
      ;;
  esac
}

config_has_storage() {
  file="$1"
  [ -f "$file" ] || return 1
  while IFS= read -r line || [ -n "$line" ]; do
    case "$line" in
      ""|\#*)
        continue
        ;;
      storage_mode=*|storage_path=*)
        return 0
        ;;
    esac
  done < "$file"
  return 1
}

write_storage_preset_to_config() {
  preset="$1"
  mkdir -p "$CONFIG_DIR"
  tmp_file=$(mktemp "$CONFIG_DIR/.${SANDBOX_NAME}.XXXXXX")

  if [ -f "$CONFIG_FILE" ]; then
    while IFS= read -r line || [ -n "$line" ]; do
      case "$line" in
        storage_mode=*|storage_path=*)
          ;;
        *)
          printf '%s\n' "$line" >> "$tmp_file"
          ;;
      esac
    done < "$CONFIG_FILE"
  fi

  if [ -s "$tmp_file" ]; then
    printf '\n' >> "$tmp_file"
  fi

  case "$preset" in
    none)
      printf 'storage_mode=none\n' >> "$tmp_file"
      ;;
    downloads)
      printf 'storage_mode=scoped\nstorage_path=0/Downloads\n' >> "$tmp_file"
      ;;
    docs)
      printf 'storage_mode=scoped\nstorage_path=0/Documents\n' >> "$tmp_file"
      ;;
    media)
      printf 'storage_mode=scoped\n' >> "$tmp_file"
      printf 'storage_path=0/DCIM\n' >> "$tmp_file"
      printf 'storage_path=0/Pictures\n' >> "$tmp_file"
      printf 'storage_path=0/Movies\n' >> "$tmp_file"
      printf 'storage_path=0/Music\n' >> "$tmp_file"
      ;;
    full)
      printf 'storage_mode=full\n' >> "$tmp_file"
      ;;
  esac

  mv "$tmp_file" "$CONFIG_FILE"
}

EDIT_CONFIG=0
STORAGE_FLAGS_PROVIDED=0

for arg in "$@"; do
  case "$arg" in
    --workdir-path)
      printf "%s\n" "$WORKDIR"
      exit 0
      ;;
    --rootfs-path)
      printf "%s\n" "$ROOTFS"
      exit 0
      ;;
    --storage|--storage=*|--storage-path|--storage-path=*)
      STORAGE_FLAGS_PROVIDED=1
      ;;
    --edit-config|--edit-storage-policy)
      EDIT_CONFIG=1
      ;;
  esac
done

if [ "$EDIT_CONFIG" -eq 1 ]; then
  mkdir -p "$CONFIG_DIR"
  if [ ! -f "$CONFIG_FILE" ]; then
    printf "# termux-sandbox config for %s\n" "$SANDBOX_NAME" > "$CONFIG_FILE"
    printf "storage_mode=none\n" >> "$CONFIG_FILE"
  fi

  if [ -n "${VISUAL:-}" ]; then
    sh -c "$VISUAL \"$CONFIG_FILE\""
    exit $?
  fi

  if [ -n "${EDITOR:-}" ]; then
    sh -c "$EDITOR \"$CONFIG_FILE\""
    exit $?
  fi

  if command -v nano >/dev/null 2>&1; then
    nano "$CONFIG_FILE"
    exit $?
  fi

  if command -v vi >/dev/null 2>&1; then
    vi "$CONFIG_FILE"
    exit $?
  fi

  echo "Error: no editor found. Set VISUAL/EDITOR or install nano/vi." >&2
  exit 1
fi

if [ ! -e "$ROOTFS/bin/bash" ]; then
  if [ ! -t 0 ]; then
    echo "Error: sandbox '$SANDBOX_NAME' does not exist and input is not interactive." >&2
    echo "Missing: $ROOTFS/bin/bash" >&2
    exit 1
  fi
  printf "Sandbox '%s' does not exist (missing %s). Create it? [y/N] " "$SANDBOX_NAME" "$ROOTFS/bin/bash" >&2
  read -r reply
  case "$reply" in
    y|Y|yes|YES)
      ;;
    *)
      echo "Aborted." >&2
      exit 1
      ;;
  esac
fi

if [ "$STORAGE_FLAGS_PROVIDED" -eq 0 ] && ! config_has_storage "$CONFIG_FILE"; then
  if [ -t 0 ]; then
    preset=$(prompt_storage_preset) || exit 1
    write_storage_preset_to_config "$preset"
  fi
fi

if [ -x "$SCRIPT_DIR/termux-sandbox" ]; then
  exec "$SCRIPT_DIR/termux-sandbox" "$SANDBOX_NAME" --config "$CONFIG_FILE" "$@"
fi

exec termux-sandbox "$SANDBOX_NAME" --config "$CONFIG_FILE" "$@"
