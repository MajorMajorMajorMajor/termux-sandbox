#!/data/data/com.termux/files/usr/bin/sh
set -eu

if [ "$#" -lt 1 ] || [ "$1" = "-h" ] || [ "$1" = "--help" ] || [ "${1#-}" != "$1" ]; then
  if [ "$#" -gt 0 ] && [ "${1#-}" != "$1" ]; then
    echo "Error: missing sandbox name before flags." >&2
  fi
  echo "Usage: asb <name> [termux-sandbox options]" >&2
  echo "Example: asb 0   # launches agent-sandbox-0" >&2
  echo "Flags: --workdir-path (print workdir) | --rootfs-path (print rootfs)" >&2
  exit 1
fi

SCRIPT_DIR=$(cd "$(dirname "$0")" && pwd)

SHORT_NAME="$1"
shift

case "$SHORT_NAME" in
  agent-sandbox-*)
    SANDBOX_NAME="$SHORT_NAME"
    ;;
  *)
    SANDBOX_NAME="agent-sandbox-$SHORT_NAME"
    ;;
esac

WORKDIR="$HOME/agent-work-${SANDBOX_NAME#agent-sandbox-}"
ROOTFS="$HOME/sandboxes/$SANDBOX_NAME"

POLICY_DIR="$HOME/.termux-sandbox/policies"
POLICY_FILE="$POLICY_DIR/$SANDBOX_NAME.storage"

prompt_storage_preset() {
  cat >&2 <<'EOF'
Choose Android storage preset:
  1) none (default)
  2) downloads (0/Downloads)
  3) docs (0/Documents)
  4) media (0/DCIM, 0/Pictures, 0/Movies, 0/Music)
  5) full (/storage/emulated)
EOF
  printf "Preset [1-5, default 1]: " >&2
  read -r storage_preset
  case "$storage_preset" in
    ""|1|none)
      echo "none"
      ;;
    2|downloads)
      echo "downloads"
      ;;
    3|docs|documents)
      echo "docs"
      ;;
    4|media)
      echo "media"
      ;;
    5|full)
      echo "full"
      ;;
    *)
      echo "Error: unknown preset '$storage_preset'." >&2
      return 1
      ;;
  esac
}

POLICY_IN_EFFECT_FILE=""
POLICY_IN_EFFECT_PRESET=""
STORAGE_FLAGS_PROVIDED=0
for arg in "$@"; do
  case "$arg" in
    --workdir-path)
      printf "%s\n" "$WORKDIR"
      exit 0
      ;;
    --rootfs-path)
      printf "%s\n" "$ROOTFS"
      exit 0
      ;;
    --storage|--storage=*|--storage-path|--storage-path=*)
      STORAGE_FLAGS_PROVIDED=1
      ;;
  esac
done

if [ ! -e "$ROOTFS/bin/bash" ]; then
  if [ ! -t 0 ]; then
    echo "Error: sandbox '$SANDBOX_NAME' does not exist and input is not interactive." >&2
    echo "Missing: $ROOTFS/bin/bash" >&2
    exit 1
  fi
  printf "Sandbox '%s' does not exist (missing %s). Create it? [y/N] " "$SANDBOX_NAME" "$ROOTFS/bin/bash" >&2
  read -r reply
  case "$reply" in
    y|Y|yes|YES)
      ;;
    *)
      echo "Aborted." >&2
      exit 1
      ;;
  esac

fi

if [ "$STORAGE_FLAGS_PROVIDED" -eq 0 ]; then
  policy_preset=""
  if [ -f "$POLICY_FILE" ]; then
    policy_preset=$(head -n 1 "$POLICY_FILE" | tr -d '\r')
  elif [ -t 0 ]; then
    policy_preset=$(prompt_storage_preset) || exit 1
    mkdir -p "$POLICY_DIR"
    printf "%s\n" "$policy_preset" > "$POLICY_FILE"
  fi

  case "$policy_preset" in
    "")
      ;;
    none)
      set -- "$@" --storage=none
      POLICY_IN_EFFECT_FILE="$POLICY_FILE"
      POLICY_IN_EFFECT_PRESET="none"
      ;;
    downloads)
      set -- "$@" --storage=scoped --storage-path 0/Downloads
      POLICY_IN_EFFECT_FILE="$POLICY_FILE"
      POLICY_IN_EFFECT_PRESET="downloads"
      ;;
    docs)
      set -- "$@" --storage=scoped --storage-path 0/Documents
      POLICY_IN_EFFECT_FILE="$POLICY_FILE"
      POLICY_IN_EFFECT_PRESET="docs"
      ;;
    media)
      set -- "$@" --storage=scoped \
        --storage-path 0/DCIM \
        --storage-path 0/Pictures \
        --storage-path 0/Movies \
        --storage-path 0/Music
      POLICY_IN_EFFECT_FILE="$POLICY_FILE"
      POLICY_IN_EFFECT_PRESET="media"
      ;;
    full)
      set -- "$@" --storage=full
      POLICY_IN_EFFECT_FILE="$POLICY_FILE"
      POLICY_IN_EFFECT_PRESET="full"
      ;;
    *)
      echo "Warning: ignoring unknown storage policy preset '$policy_preset' in $POLICY_FILE" >&2
      ;;
  esac
fi

if [ -x "$SCRIPT_DIR/termux-sandbox" ]; then
  exec env \
    TERMUX_SANDBOX_STORAGE_POLICY_FILE="${POLICY_IN_EFFECT_FILE:-}" \
    TERMUX_SANDBOX_STORAGE_POLICY_PRESET="${POLICY_IN_EFFECT_PRESET:-}" \
    "$SCRIPT_DIR/termux-sandbox" "$SANDBOX_NAME" "$@"
fi

exec env \
  TERMUX_SANDBOX_STORAGE_POLICY_FILE="${POLICY_IN_EFFECT_FILE:-}" \
  TERMUX_SANDBOX_STORAGE_POLICY_PRESET="${POLICY_IN_EFFECT_PRESET:-}" \
  termux-sandbox "$SANDBOX_NAME" "$@"
