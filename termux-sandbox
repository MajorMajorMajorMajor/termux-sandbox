#!/data/data/com.termux/files/usr/bin/sh

usage() {
  cat >&2 <<'EOF'
Usage: termux-sandbox <name> [options]

Options:
  --bootstrap[=MODE]       Bootstrap mode: termux (default), prefix, mirror, url, file
  --bootstrap-url URL      Download bootstrap zip from URL
  --bootstrap-file PATH    Use an existing bootstrap zip file
  --no-bootstrap           Do not bootstrap; error if rootfs missing bin/bash
  --rootfs DIR             Override rootfs location
  --workdir DIR            Override workdir location
  -h, --help               Show this help
EOF
}

if ! command -v proot >/dev/null 2>&1; then
  echo "Error: proot is not installed. Install with: pkg install proot" >&2
  exit 1
fi

SANDBOX_NAME=""
BOOTSTRAP_MODE="termux"
ROOTFS=""
WORKDIR=""
BOOTSTRAP_URL=""
BOOTSTRAP_FILE=""

while [ "$#" -gt 0 ]; do
  case "$1" in
    -h|--help)
      usage
      exit 0
      ;;
    --bootstrap)
      BOOTSTRAP_MODE="termux"
      ;;
    --bootstrap=*)
      BOOTSTRAP_MODE="${1#--bootstrap=}"
      ;;
    --no-bootstrap)
      BOOTSTRAP_MODE="none"
      ;;
    --bootstrap-url)
      shift
      if [ -z "$1" ]; then
        echo "Error: --bootstrap-url requires a URL." >&2
        usage
        exit 1
      fi
      BOOTSTRAP_URL="$1"
      BOOTSTRAP_MODE="url"
      ;;
    --bootstrap-url=*)
      BOOTSTRAP_URL="${1#--bootstrap-url=}"
      BOOTSTRAP_MODE="url"
      ;;
    --bootstrap-file)
      shift
      if [ -z "$1" ]; then
        echo "Error: --bootstrap-file requires a path." >&2
        usage
        exit 1
      fi
      BOOTSTRAP_FILE="$1"
      BOOTSTRAP_MODE="file"
      ;;
    --bootstrap-file=*)
      BOOTSTRAP_FILE="${1#--bootstrap-file=}"
      BOOTSTRAP_MODE="file"
      ;;
    --rootfs)
      shift
      if [ -z "$1" ]; then
        echo "Error: --rootfs requires a directory." >&2
        usage
        exit 1
      fi
      ROOTFS="$1"
      ;;
    --workdir)
      shift
      if [ -z "$1" ]; then
        echo "Error: --workdir requires a directory." >&2
        usage
        exit 1
      fi
      WORKDIR="$1"
      ;;
    --)
      shift
      break
      ;;
    -* )
      echo "Error: Unknown option: $1" >&2
      usage
      exit 1
      ;;
    *)
      if [ -z "$SANDBOX_NAME" ]; then
        SANDBOX_NAME="$1"
      else
        echo "Error: Unexpected argument: $1" >&2
        usage
        exit 1
      fi
      ;;
  esac
  shift
 done

if [ -z "$SANDBOX_NAME" ]; then
  usage
  exit 1
fi

if [ -z "$ROOTFS" ]; then
  ROOTFS="$HOME/sandboxes/$SANDBOX_NAME"
fi

if [ -z "$WORKDIR" ]; then
  WORKDIR="$HOME/agent-work-${SANDBOX_NAME#agent-sandbox-}"
fi

mkdir -p "$ROOTFS" "$WORKDIR"

HOST_PREFIX="/data/data/com.termux/files/usr"

map_arch() {
  case "$(uname -m)" in
    aarch64|arm64) echo "aarch64" ;;
    armv7l|armv8l|arm) echo "arm" ;;
    i686|i386) echo "i686" ;;
    x86_64) echo "x86_64" ;;
    *)
      echo "" ;;
  esac
}

ensure_unzip() {
  if ! command -v unzip >/dev/null 2>&1; then
    echo "Error: unzip is required. Install with: pkg install unzip" >&2
    exit 1
  fi
}

download_file() {
  url="$1"
  dest="$2"
  if command -v curl >/dev/null 2>&1; then
    curl -L -o "$dest" "$url"
  elif command -v wget >/dev/null 2>&1; then
    wget -O "$dest" "$url"
  else
    echo "Error: curl or wget is required to download bootstraps." >&2
    exit 1
  fi
}

map_apk_arch() {
  case "$(uname -m)" in
    aarch64|arm64) echo "arm64-v8a" ;;
    armv7l|armv8l|arm) echo "armeabi-v7a" ;;
    i686|i386) echo "x86" ;;
    x86_64) echo "x86_64" ;;
    *)
      echo "" ;;
  esac
}

get_termux_apk_path() {
  if [ -n "$TERMUX_APP__APK_FILE_PATH" ] && [ -f "$TERMUX_APP__APK_FILE_PATH" ]; then
    echo "$TERMUX_APP__APK_FILE_PATH"
    return 0
  fi

  for pm_cmd in pm /system/bin/pm; do
    if [ "$pm_cmd" = "pm" ]; then
      command -v pm >/dev/null 2>&1 || continue
    else
      [ -x /system/bin/pm ] || continue
    fi
    apk_path=$($pm_cmd path com.termux 2>/dev/null | head -n1 | sed 's/package://')
    if [ -n "$apk_path" ] && [ -f "$apk_path" ]; then
      echo "$apk_path"
      return 0
    fi
  done

  apk_path=$(find /data/app -maxdepth 4 -type f -name base.apk -path '*com.termux*' 2>/dev/null | head -n1)
  if [ -n "$apk_path" ] && [ -f "$apk_path" ]; then
    echo "$apk_path"
    return 0
  fi

  return 1
}

extract_bootstrap_from_termux() {
  apk_path=$(get_termux_apk_path)
  if [ -z "$apk_path" ]; then
    echo "Error: could not locate Termux APK path." >&2
    exit 1
  fi
  ensure_unzip
  tmp_dir=$(mktemp -d)
  lib_path=""
  apk_dir=$(dirname "$apk_path")
  if [ -d "$apk_dir/lib" ]; then
    for libdir in "$apk_dir"/lib/*; do
      if [ -f "$libdir/libtermux-bootstrap.so" ]; then
        lib_path="$libdir/libtermux-bootstrap.so"
        break
      fi
    done
  fi
  if [ -n "$lib_path" ]; then
    cp "$lib_path" "$tmp_dir/libtermux-bootstrap.zip"
  else
    apk_arch=$(map_apk_arch)
    if [ -z "$apk_arch" ]; then
      echo "Error: unsupported architecture for APK extraction: $(uname -m)" >&2
      rm -rf "$tmp_dir"
      exit 1
    fi
    unzip -p "$apk_path" "lib/$apk_arch/libtermux-bootstrap.so" > "$tmp_dir/libtermux-bootstrap.zip"
  fi
  if [ ! -s "$tmp_dir/libtermux-bootstrap.zip" ]; then
    echo "Error: could not locate Termux bootstrap library." >&2
    rm -rf "$tmp_dir"
    exit 1
  fi
  if unzip -l "$tmp_dir/libtermux-bootstrap.zip" 2>/dev/null | awk '{print $4}' | grep -qx ".rodata"; then
    unzip -p "$tmp_dir/libtermux-bootstrap.zip" .rodata > "$tmp_dir/bootstrap.zip"
    if [ ! -s "$tmp_dir/bootstrap.zip" ]; then
      echo "Error: failed to extract bootstrap archive from Termux app." >&2
      rm -rf "$tmp_dir"
      exit 1
    fi
    unzip -q "$tmp_dir/bootstrap.zip" -d "$ROOTFS"
  else
    unzip -q "$tmp_dir/libtermux-bootstrap.zip" -d "$ROOTFS"
  fi
  rm -rf "$tmp_dir"
}

bootstrap_from_prefix() {
  echo "Bootstrapping sandbox '$SANDBOX_NAME' from current Termux prefix..." >&2
  echo "Rootfs: $ROOTFS" >&2
  if command -v rsync >/dev/null 2>&1; then
    rsync -a --delete "$HOST_PREFIX/" "$ROOTFS/"
  else
    cp -a "$HOST_PREFIX/." "$ROOTFS/"
  fi
}

bootstrap_from_mirror() {
  arch=$(map_arch)
  if [ -z "$arch" ]; then
    echo "Error: unsupported architecture: $(uname -m)" >&2
    exit 1
  fi
  mirror_url=""
  for list in "$HOST_PREFIX/etc/apt/sources.list" "$HOST_PREFIX/etc/apt/sources.list.d"/*.list; do
    [ -f "$list" ] || continue
    mirror_url=$(awk '$1=="deb" {print $2; exit}' "$list")
    [ -n "$mirror_url" ] && break
  done
  if [ -z "$mirror_url" ]; then
    echo "Error: could not determine Termux mirror from apt sources." >&2
    exit 1
  fi
  mirror_base=$(printf "%s" "$mirror_url" | sed 's#/apt/.*##')
  if [ -z "$mirror_base" ]; then
    echo "Error: failed to parse mirror base from $mirror_url" >&2
    exit 1
  fi
  ensure_unzip
  tmp_dir=$(mktemp -d)
  bootstrap_zip="$tmp_dir/bootstrap-$arch.zip"
  url="$mirror_base/bootstrap/bootstrap-$arch.zip"
  echo "Downloading bootstrap from $url" >&2
  download_file "$url" "$bootstrap_zip"
  unzip -q "$bootstrap_zip" -d "$ROOTFS"
  rm -rf "$tmp_dir"
}

bootstrap_from_url() {
  arch=$(map_arch)
  if [ -z "$arch" ]; then
    echo "Error: unsupported architecture: $(uname -m)" >&2
    exit 1
  fi
  ensure_unzip
  tmp_dir=$(mktemp -d)
  bootstrap_zip="$tmp_dir/bootstrap-$arch.zip"
  echo "Downloading bootstrap from $BOOTSTRAP_URL" >&2
  download_file "$BOOTSTRAP_URL" "$bootstrap_zip"
  unzip -q "$bootstrap_zip" -d "$ROOTFS"
  rm -rf "$tmp_dir"
}

bootstrap_from_file() {
  ensure_unzip
  if [ ! -f "$BOOTSTRAP_FILE" ]; then
    echo "Error: bootstrap file not found: $BOOTSTRAP_FILE" >&2
    exit 1
  fi
  unzip -q "$BOOTSTRAP_FILE" -d "$ROOTFS"
}

apply_symlinks() {
  symlink_file="$ROOTFS/SYMLINKS.txt"
  [ -f "$symlink_file" ] || return 0
  while IFS= read -r line; do
    [ -n "$line" ] || continue
    case "$line" in
      *"←"*)
        target="${line%%←*}"
        link="${line#*←}"
        ;;
      *)
        continue
        ;;
    esac
    target="${target#./}"
    link="${link#./}"
    [ -n "$link" ] || continue
    mkdir -p "$ROOTFS/$(dirname "$link")"
    ln -sfn "$target" "$ROOTFS/$link"
  done < "$symlink_file"
}

if [ ! -x "$ROOTFS/bin/bash" ]; then
  case "$BOOTSTRAP_MODE" in
    none)
      echo "Error: rootfs is missing $HOST_PREFIX/bin/bash." >&2
      echo "Hint: run with --bootstrap or provide a bootstrap source." >&2
      exit 1
      ;;
    termux)
      echo "Bootstrapping sandbox '$SANDBOX_NAME' from Termux app bootstrap..." >&2
      echo "Rootfs: $ROOTFS" >&2
      extract_bootstrap_from_termux
      ;;
    prefix)
      bootstrap_from_prefix
      ;;
    mirror)
      echo "Bootstrapping sandbox '$SANDBOX_NAME' from Termux mirror..." >&2
      echo "Rootfs: $ROOTFS" >&2
      bootstrap_from_mirror
      ;;
    url)
      if [ -z "$BOOTSTRAP_URL" ]; then
        echo "Error: --bootstrap-url must be provided when using bootstrap url." >&2
        exit 1
      fi
      echo "Bootstrapping sandbox '$SANDBOX_NAME' from URL..." >&2
      echo "Rootfs: $ROOTFS" >&2
      bootstrap_from_url
      ;;
    file)
      if [ -z "$BOOTSTRAP_FILE" ]; then
        echo "Error: --bootstrap-file must be provided when using bootstrap file." >&2
        exit 1
      fi
      echo "Bootstrapping sandbox '$SANDBOX_NAME' from file..." >&2
      echo "Rootfs: $ROOTFS" >&2
      bootstrap_from_file
      ;;
    *)
      echo "Error: unknown bootstrap mode: $BOOTSTRAP_MODE" >&2
      usage
      exit 1
      ;;
  esac
  apply_symlinks
fi

mkdir -p "$ROOTFS/home/agent"
mkdir -p "$ROOTFS/home/agent/work"
mkdir -p "$ROOTFS/etc/dpkg/dpkg.cfg.d"

LOCK_DIR="$ROOTFS/etc/termux/termux-bootstrap/second-stage"
if [ -d "$LOCK_DIR" ]; then
  ln -sf "termux-bootstrap-second-stage.sh" "$LOCK_DIR/termux-bootstrap-second-stage.sh.lock"
fi

ENV_TERM=${TERM:-xterm-256color}
ENV_PATH="$HOST_PREFIX/bin:$HOST_PREFIX/bin/applets"

exec env -i \
  TERM="$ENV_TERM" \
  HOME=/data/data/com.termux/files/usr/home/agent \
  PREFIX=/data/data/com.termux/files/usr \
  TERMUX_PREFIX=/data/data/com.termux/files/usr \
  PATH="$ENV_PATH" \
  proot \
  --link2symlink \
  -0 \
  -b "$ROOTFS":/data/data/com.termux/files/usr \
  -b "$WORKDIR":/data/data/com.termux/files/usr/home/agent/work \
  -b /dev -b /proc -b /sys -b /system -b /apex \
  -w /data/data/com.termux/files/usr/home/agent \
  /data/data/com.termux/files/usr/bin/bash -lc '
    export PREFIX=/data/data/com.termux/files/usr
    export TERMUX_PREFIX=$PREFIX
    export HOME=/data/data/com.termux/files/usr/home/agent
    export PATH="$PREFIX/bin:$PREFIX/bin/applets:$PATH"
    cd "$HOME/work"
    exec bash'
