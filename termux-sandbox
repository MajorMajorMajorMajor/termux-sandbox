#!/data/data/com.termux/files/usr/bin/sh

usage() {
  cat >&2 <<'EOF'
Usage: termux-sandbox <name> [options]

Options:
  --bootstrap[=MODE]       Bootstrap mode: termux (default), prefix, mirror, url, file
  --bootstrap-url URL      Download bootstrap zip from URL
  --bootstrap-file PATH    Use an existing bootstrap zip file
  --no-bootstrap           Do not bootstrap; error if rootfs missing bin/bash
  --rootfs DIR             Override rootfs location
  --workdir DIR            Override workdir location
  -h, --help               Show this help
EOF
}

if ! command -v proot >/dev/null 2>&1; then
  echo "Error: proot is not installed. Install with: pkg install proot" >&2
  exit 1
fi

SCRIPT_DIR=$(cd "$(dirname "$0")" && pwd)

SANDBOX_NAME=""
BOOTSTRAP_MODE="termux"
ROOTFS=""
WORKDIR=""
BOOTSTRAP_URL=""
BOOTSTRAP_FILE=""

while [ "$#" -gt 0 ]; do
  case "$1" in
    -h|--help)
      usage
      exit 0
      ;;
    --bootstrap)
      BOOTSTRAP_MODE="termux"
      ;;
    --bootstrap=*)
      BOOTSTRAP_MODE="${1#--bootstrap=}"
      ;;
    --no-bootstrap)
      BOOTSTRAP_MODE="none"
      ;;
    --bootstrap-url)
      shift
      if [ -z "$1" ]; then
        echo "Error: --bootstrap-url requires a URL." >&2
        usage
        exit 1
      fi
      BOOTSTRAP_URL="$1"
      BOOTSTRAP_MODE="url"
      ;;
    --bootstrap-url=*)
      BOOTSTRAP_URL="${1#--bootstrap-url=}"
      BOOTSTRAP_MODE="url"
      ;;
    --bootstrap-file)
      shift
      if [ -z "$1" ]; then
        echo "Error: --bootstrap-file requires a path." >&2
        usage
        exit 1
      fi
      BOOTSTRAP_FILE="$1"
      BOOTSTRAP_MODE="file"
      ;;
    --bootstrap-file=*)
      BOOTSTRAP_FILE="${1#--bootstrap-file=}"
      BOOTSTRAP_MODE="file"
      ;;
    --rootfs)
      shift
      if [ -z "$1" ]; then
        echo "Error: --rootfs requires a directory." >&2
        usage
        exit 1
      fi
      ROOTFS="$1"
      ;;
    --workdir)
      shift
      if [ -z "$1" ]; then
        echo "Error: --workdir requires a directory." >&2
        usage
        exit 1
      fi
      WORKDIR="$1"
      ;;
    --)
      shift
      break
      ;;
    -* )
      echo "Error: Unknown option: $1" >&2
      usage
      exit 1
      ;;
    *)
      if [ -z "$SANDBOX_NAME" ]; then
        SANDBOX_NAME="$1"
      else
        echo "Error: Unexpected argument: $1" >&2
        usage
        exit 1
      fi
      ;;
  esac
  shift
 done

if [ -z "$SANDBOX_NAME" ]; then
  usage
  exit 1
fi

if [ -z "$ROOTFS" ]; then
  ROOTFS="$HOME/sandboxes/$SANDBOX_NAME"
fi

if [ -z "$WORKDIR" ]; then
  WORKDIR="$HOME/agent-work-${SANDBOX_NAME#agent-sandbox-}"
fi

mkdir -p "$ROOTFS" "$WORKDIR"

HOST_PREFIX="/data/data/com.termux/files/usr"

map_arch() {
  case "$(uname -m)" in
    aarch64|arm64) echo "aarch64" ;;
    armv7l|armv8l|arm) echo "arm" ;;
    i686|i386) echo "i686" ;;
    x86_64) echo "x86_64" ;;
    *)
      echo "" ;;
  esac
}

ensure_unzip() {
  if ! command -v unzip >/dev/null 2>&1; then
    echo "Error: unzip is required. Install with: pkg install unzip" >&2
    exit 1
  fi
}

download_file() {
  url="$1"
  dest="$2"
  if command -v curl >/dev/null 2>&1; then
    curl -L -o "$dest" "$url"
  elif command -v wget >/dev/null 2>&1; then
    wget -O "$dest" "$url"
  else
    echo "Error: curl or wget is required to download bootstraps." >&2
    exit 1
  fi
}

find_helper() {
  helper="$1"
  for dir in "$SCRIPT_DIR/scripts" "$HOME/.termux-sandbox/scripts"; do
    if [ -x "$dir/$helper" ]; then
      echo "$dir/$helper"
      return 0
    fi
  done
  return 1
}

run_helper() {
  helper_path=$(find_helper "$1")
  if [ -z "$helper_path" ]; then
    echo "Error: helper script '$1' not found. Ensure scripts are installed." >&2
    exit 1
  fi
  shift
  "$helper_path" "$@"
}

extract_bootstrap_from_termux() {
  run_helper "extract-bootstrap.sh" "$ROOTFS"
}

bootstrap_from_prefix() {
  echo "Bootstrapping sandbox '$SANDBOX_NAME' from current Termux prefix..." >&2
  echo "Rootfs: $ROOTFS" >&2
  if command -v rsync >/dev/null 2>&1; then
    rsync -a --delete "$HOST_PREFIX/" "$ROOTFS/"
  else
    cp -a "$HOST_PREFIX/." "$ROOTFS/"
  fi
}

bootstrap_from_mirror() {
  arch=$(map_arch)
  if [ -z "$arch" ]; then
    echo "Error: unsupported architecture: $(uname -m)" >&2
    exit 1
  fi
  mirror_url=""
  for list in "$HOST_PREFIX/etc/apt/sources.list" "$HOST_PREFIX/etc/apt/sources.list.d"/*.list; do
    [ -f "$list" ] || continue
    mirror_url=$(awk '$1=="deb" {print $2; exit}' "$list")
    [ -n "$mirror_url" ] && break
  done
  if [ -z "$mirror_url" ]; then
    echo "Error: could not determine Termux mirror from apt sources." >&2
    exit 1
  fi
  mirror_base=$(printf "%s" "$mirror_url" | sed 's#/apt/.*##')
  if [ -z "$mirror_base" ]; then
    echo "Error: failed to parse mirror base from $mirror_url" >&2
    exit 1
  fi
  ensure_unzip
  tmp_dir=$(mktemp -d)
  bootstrap_zip="$tmp_dir/bootstrap-$arch.zip"
  url="$mirror_base/bootstrap/bootstrap-$arch.zip"
  echo "Downloading bootstrap from $url" >&2
  download_file "$url" "$bootstrap_zip"
  unzip -q "$bootstrap_zip" -d "$ROOTFS"
  rm -rf "$tmp_dir"
}

bootstrap_from_url() {
  arch=$(map_arch)
  if [ -z "$arch" ]; then
    echo "Error: unsupported architecture: $(uname -m)" >&2
    exit 1
  fi
  ensure_unzip
  tmp_dir=$(mktemp -d)
  bootstrap_zip="$tmp_dir/bootstrap-$arch.zip"
  echo "Downloading bootstrap from $BOOTSTRAP_URL" >&2
  download_file "$BOOTSTRAP_URL" "$bootstrap_zip"
  unzip -q "$bootstrap_zip" -d "$ROOTFS"
  rm -rf "$tmp_dir"
}

bootstrap_from_file() {
  ensure_unzip
  if [ ! -f "$BOOTSTRAP_FILE" ]; then
    echo "Error: bootstrap file not found: $BOOTSTRAP_FILE" >&2
    exit 1
  fi
  unzip -q "$BOOTSTRAP_FILE" -d "$ROOTFS"
}

apply_symlinks() {
  echo "Applying Termux symlinks (this can take a while)..." >&2
  run_helper "apply-symlinks.sh" "$ROOTFS"
}

write_prompt_rc() {
  rc_path="$ROOTFS/etc/termux-sandbox-rc"
  mkdir -p "$(dirname "$rc_path")"
  cat > "$rc_path" <<'EOF'
# Generated by termux-sandbox. Sources standard bash config then adds a prompt marker.
if [ -f /data/data/com.termux/files/usr/etc/bash.bashrc ]; then
  . /data/data/com.termux/files/usr/etc/bash.bashrc
fi
if [ -f "$HOME/.bashrc" ]; then
  . "$HOME/.bashrc"
fi
if [ -n "${TERMUX_SANDBOX_PATH_PREPEND:-}" ]; then
  case ":$PATH:" in
    *":$TERMUX_SANDBOX_PATH_PREPEND:"*) ;;
    *) PATH="$TERMUX_SANDBOX_PATH_PREPEND:$PATH" ;;
  esac
fi
if [ -n "${PS1:-}" ]; then
  TERMUX_SANDBOX_NAME="${TERMUX_SANDBOX_NAME:-sandbox}"
  TERMUX_SANDBOX_PROMPT_TEXT="[${TERMUX_SANDBOX_NAME}] "
  TERMUX_SANDBOX_COLORS=(96 92 93 95 94 91 97)
  TERMUX_SANDBOX_COLOR_INDEX=0
  if command -v od >/dev/null 2>&1; then
    for value in $(printf '%s' "$TERMUX_SANDBOX_NAME" | od -An -tu1); do
      TERMUX_SANDBOX_COLOR_INDEX=$((TERMUX_SANDBOX_COLOR_INDEX + value))
    done
  fi
  TERMUX_SANDBOX_COLOR=${TERMUX_SANDBOX_COLORS[$((TERMUX_SANDBOX_COLOR_INDEX % ${#TERMUX_SANDBOX_COLORS[@]}))]}
  TERMUX_SANDBOX_PROMPT_PREFIX="\[\e[1;${TERMUX_SANDBOX_COLOR}m\]${TERMUX_SANDBOX_PROMPT_TEXT}\[\e[0m\]"
  case "$PS1" in
    *"$TERMUX_SANDBOX_PROMPT_TEXT"*) ;;
    *) PS1="${TERMUX_SANDBOX_PROMPT_PREFIX}${PS1}" ;;
  esac
fi
EOF
}

if [ ! -x "$ROOTFS/bin/bash" ]; then
  case "$BOOTSTRAP_MODE" in
    none)
      echo "Error: rootfs is missing $HOST_PREFIX/bin/bash." >&2
      echo "Hint: run with --bootstrap or provide a bootstrap source." >&2
      exit 1
      ;;
    termux)
      echo "Bootstrapping sandbox '$SANDBOX_NAME' from Termux app bootstrap..." >&2
      echo "Rootfs: $ROOTFS" >&2
      extract_bootstrap_from_termux
      ;;
    prefix)
      bootstrap_from_prefix
      ;;
    mirror)
      echo "Bootstrapping sandbox '$SANDBOX_NAME' from Termux mirror..." >&2
      echo "Rootfs: $ROOTFS" >&2
      bootstrap_from_mirror
      ;;
    url)
      if [ -z "$BOOTSTRAP_URL" ]; then
        echo "Error: --bootstrap-url must be provided when using bootstrap url." >&2
        exit 1
      fi
      echo "Bootstrapping sandbox '$SANDBOX_NAME' from URL..." >&2
      echo "Rootfs: $ROOTFS" >&2
      bootstrap_from_url
      ;;
    file)
      if [ -z "$BOOTSTRAP_FILE" ]; then
        echo "Error: --bootstrap-file must be provided when using bootstrap file." >&2
        exit 1
      fi
      echo "Bootstrapping sandbox '$SANDBOX_NAME' from file..." >&2
      echo "Rootfs: $ROOTFS" >&2
      bootstrap_from_file
      ;;
    *)
      echo "Error: unknown bootstrap mode: $BOOTSTRAP_MODE" >&2
      usage
      exit 1
      ;;
  esac
  apply_symlinks
fi

mkdir -p "$ROOTFS/home/agent"
mkdir -p "$ROOTFS/home/agent/work"
mkdir -p "$ROOTFS/etc/dpkg/dpkg.cfg.d"

ensure_sticky_tmp() {
  dir="$1"
  mkdir -p "$dir"
  if ! chmod 1777 "$dir" 2>/dev/null; then
    rm -rf "$dir"
    mkdir -p "$dir"
    chmod 1777 "$dir"
  fi
}

ensure_sticky_tmp "$ROOTFS/tmp"
ensure_sticky_tmp "$ROOTFS/var/tmp"

if [ -f "$ROOTFS/SYMLINKS.txt" ] && [ ! -e "$ROOTFS/bin/chmod" ]; then
  apply_symlinks
fi

write_prompt_rc

LOCK_DIR="$ROOTFS/etc/termux/termux-bootstrap/second-stage"
if [ -d "$LOCK_DIR" ]; then
  ln -sf "termux-bootstrap-second-stage.sh" "$LOCK_DIR/termux-bootstrap-second-stage.sh.lock"
fi

ENV_TERM=${TERM:-xterm-256color}
ENV_PATH="$HOST_PREFIX/bin:$HOST_PREFIX/bin/applets"

ENV_LD_PRELOAD="$HOST_PREFIX/lib/libtermux-exec-ld-preload.so"

# Start the host-side relay for am/Android commands
RELAY_DIR="$ROOTFS/tmp/sandbox-relay"
relay_helper=$(find_helper "sandbox-relay.sh") || true
relay_client=$(find_helper "sandbox-relay-client.sh") || true

RELAY_PID=""
SANDBOX_BIN=""
SANDBOX_PATH_PREPEND=""
if [ -n "$relay_helper" ] && [ -n "$relay_client" ]; then
  rm -rf "$RELAY_DIR"
  "$relay_helper" "$RELAY_DIR" &
  RELAY_PID=$!

  # Install relay client in a PATH overlay (preserves original bin/am)
  SANDBOX_BIN="$ROOTFS/tmp/sandbox-bin"
  mkdir -p "$SANDBOX_BIN"
  cp "$relay_client" "$SANDBOX_BIN/am"
  chmod 755 "$SANDBOX_BIN/am"
fi

# If relay is active, prepend the overlay so sandbox-bin/am is found first
if [ -n "$SANDBOX_BIN" ]; then
  SANDBOX_PATH_PREPEND="$HOST_PREFIX/tmp/sandbox-bin"
  ENV_PATH="$SANDBOX_PATH_PREPEND:$ENV_PATH"
fi

cleanup_relay() {
  [ -n "$RELAY_PID" ] && kill "$RELAY_PID" 2>/dev/null || true
  rm -rf "$RELAY_DIR"
  [ -n "$SANDBOX_BIN" ] && rm -rf "$SANDBOX_BIN"
}
trap cleanup_relay EXIT

env -i \
  TERM="$ENV_TERM" \
  HOME=/data/data/com.termux/files/usr/home/agent \
  PREFIX=/data/data/com.termux/files/usr \
  TERMUX_PREFIX=/data/data/com.termux/files/usr \
  TERMUX_SANDBOX_NAME="$SANDBOX_NAME" \
  TERMUX_SANDBOX_PATH_PREPEND="$SANDBOX_PATH_PREPEND" \
  LD_PRELOAD="$ENV_LD_PRELOAD" \
  PATH="$ENV_PATH" \
  proot \
  --kill-on-exit \
  --link2symlink \
  -b "$ROOTFS":/data/data/com.termux/files/usr \
  -b "$WORKDIR":/data/data/com.termux/files/usr/home/agent/work \
  -b "$ROOTFS/tmp":/tmp \
  -b "$ROOTFS/var/tmp":/var/tmp \
  -b /dev -b /proc -b /sys -b /system -b /apex \
  -w /data/data/com.termux/files/usr/home/agent \
  /data/data/com.termux/files/usr/bin/bash -lc '
    export PREFIX=/data/data/com.termux/files/usr
    export TERMUX_PREFIX=$PREFIX
    export HOME=/data/data/com.termux/files/usr/home/agent
    cd "$HOME/work"
    exec bash --rcfile /data/data/com.termux/files/usr/etc/termux-sandbox-rc'
