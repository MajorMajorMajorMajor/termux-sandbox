#!/data/data/com.termux/files/usr/bin/sh
set -eu

usage() {
  cat >&2 <<'EOF'
Usage: termux-sandbox <name> [options]

Options:
  --bootstrap[=MODE]       Bootstrap mode: termux (default), prefix, mirror, url, file
  --bootstrap-url URL      Download bootstrap zip from URL
  --bootstrap-file PATH    Use an existing bootstrap zip file
  --no-bootstrap           Do not bootstrap; error if rootfs missing bin/bash
  --rootfs DIR             Override rootfs location
  --workdir DIR            Override workdir location
  --storage MODE           Android storage access: none (default), scoped, full
  --storage-path RELPATH   Path under /storage/emulated (repeatable, implies scoped)
  -h, --help               Show this help
EOF
}

if ! command -v proot >/dev/null 2>&1; then
  echo "Error: proot is not installed. Install with: pkg install proot" >&2
  exit 1
fi

SCRIPT_DIR=$(cd "$(dirname "$0")" && pwd)
TERMUX_SANDBOX_SCRIPT_DIR="$SCRIPT_DIR"

find_library() {
  for dir in "$SCRIPT_DIR/scripts" "$HOME/.termux-sandbox/scripts"; do
    if [ -f "$dir/termux-sandbox-lib.sh" ]; then
      echo "$dir/termux-sandbox-lib.sh"
      return 0
    fi
  done
  return 1
}

LIB_PATH=$(find_library) || {
  echo "Error: helper library 'termux-sandbox-lib.sh' not found." >&2
  echo "Install scripts to ~/.termux-sandbox/scripts or run from repository root." >&2
  exit 1
}

# shellcheck source=/dev/null
. "$LIB_PATH"

SANDBOX_NAME=""
BOOTSTRAP_MODE="termux"
ROOTFS=""
WORKDIR=""
BOOTSTRAP_URL=""
BOOTSTRAP_FILE=""
STORAGE_MODE="none"
STORAGE_PATHS=""

while [ "$#" -gt 0 ]; do
  case "$1" in
    -h|--help)
      usage
      exit 0
      ;;
    --bootstrap)
      BOOTSTRAP_MODE="termux"
      ;;
    --bootstrap=*)
      BOOTSTRAP_MODE="${1#--bootstrap=}"
      ;;
    --no-bootstrap)
      BOOTSTRAP_MODE="none"
      ;;
    --bootstrap-url)
      shift
      if [ -z "${1:-}" ]; then
        echo "Error: --bootstrap-url requires a URL." >&2
        usage
        exit 1
      fi
      BOOTSTRAP_URL="$1"
      BOOTSTRAP_MODE="url"
      ;;
    --bootstrap-url=*)
      BOOTSTRAP_URL="${1#--bootstrap-url=}"
      BOOTSTRAP_MODE="url"
      ;;
    --bootstrap-file)
      shift
      if [ -z "${1:-}" ]; then
        echo "Error: --bootstrap-file requires a path." >&2
        usage
        exit 1
      fi
      BOOTSTRAP_FILE="$1"
      BOOTSTRAP_MODE="file"
      ;;
    --bootstrap-file=*)
      BOOTSTRAP_FILE="${1#--bootstrap-file=}"
      BOOTSTRAP_MODE="file"
      ;;
    --rootfs)
      shift
      if [ -z "${1:-}" ]; then
        echo "Error: --rootfs requires a directory." >&2
        usage
        exit 1
      fi
      ROOTFS="$1"
      ;;
    --workdir)
      shift
      if [ -z "${1:-}" ]; then
        echo "Error: --workdir requires a directory." >&2
        usage
        exit 1
      fi
      WORKDIR="$1"
      ;;
    --storage)
      shift
      if [ -z "${1:-}" ]; then
        echo "Error: --storage requires a mode." >&2
        usage
        exit 1
      fi
      STORAGE_MODE="$1"
      ;;
    --storage=*)
      STORAGE_MODE="${1#--storage=}"
      ;;
    --storage-path)
      shift
      if [ -z "${1:-}" ]; then
        echo "Error: --storage-path requires a path under /storage/emulated." >&2
        usage
        exit 1
      fi
      if [ -n "$STORAGE_PATHS" ]; then
        STORAGE_PATHS="$STORAGE_PATHS
$1"
      else
        STORAGE_PATHS="$1"
      fi
      if [ "$STORAGE_MODE" = "none" ]; then
        STORAGE_MODE="scoped"
      fi
      ;;
    --storage-path=*)
      path_value="${1#--storage-path=}"
      if [ -z "$path_value" ]; then
        echo "Error: --storage-path requires a path under /storage/emulated." >&2
        usage
        exit 1
      fi
      if [ -n "$STORAGE_PATHS" ]; then
        STORAGE_PATHS="$STORAGE_PATHS
$path_value"
      else
        STORAGE_PATHS="$path_value"
      fi
      if [ "$STORAGE_MODE" = "none" ]; then
        STORAGE_MODE="scoped"
      fi
      ;;
    --)
      shift
      break
      ;;
    -* )
      echo "Error: Unknown option: $1" >&2
      usage
      exit 1
      ;;
    *)
      if [ -z "$SANDBOX_NAME" ]; then
        SANDBOX_NAME="$1"
      else
        echo "Error: Unexpected argument: $1" >&2
        usage
        exit 1
      fi
      ;;
  esac
  shift
done

if [ -z "$SANDBOX_NAME" ]; then
  usage
  exit 1
fi

case "$STORAGE_MODE" in
  none|scoped|full)
    ;;
  *)
    echo "Error: unknown --storage mode: $STORAGE_MODE" >&2
    usage
    exit 1
    ;;
esac

if [ "$STORAGE_MODE" != "scoped" ] && [ -n "$STORAGE_PATHS" ]; then
  echo "Error: --storage-path can only be used with --storage=scoped." >&2
  exit 1
fi

if [ "$STORAGE_MODE" = "scoped" ] && [ -n "$STORAGE_PATHS" ]; then
  while IFS= read -r rel_path; do
    [ -n "$rel_path" ] || continue
    if ! termux_sandbox_validate_storage_path "$rel_path"; then
      exit 1
    fi
  done <<EOF
$STORAGE_PATHS
EOF
fi

if [ -z "$ROOTFS" ]; then
  ROOTFS="$HOME/sandboxes/$SANDBOX_NAME"
fi

if [ -z "$WORKDIR" ]; then
  WORKDIR="$HOME/agent-work-${SANDBOX_NAME#agent-sandbox-}"
fi

mkdir -p "$ROOTFS" "$WORKDIR"

HOST_PREFIX="/data/data/com.termux/files/usr"

if ! termux_sandbox_bootstrap_if_needed "$BOOTSTRAP_MODE" "$SANDBOX_NAME" "$ROOTFS" "$HOST_PREFIX" "$BOOTSTRAP_URL" "$BOOTSTRAP_FILE"; then
  usage
  exit 1
fi

termux_sandbox_prepare_rootfs "$ROOTFS"
termux_sandbox_write_prompt_rc "$ROOTFS"

LOCK_DIR="$ROOTFS/etc/termux/termux-bootstrap/second-stage"
if [ -d "$LOCK_DIR" ]; then
  ln -sf "termux-bootstrap-second-stage.sh" "$LOCK_DIR/termux-bootstrap-second-stage.sh.lock"
fi

ENV_TERM=${TERM:-xterm-256color}
ENV_PATH="$HOST_PREFIX/bin:$HOST_PREFIX/bin/applets"
ENV_LD_PRELOAD="$HOST_PREFIX/lib/libtermux-exec-ld-preload.so"

termux_sandbox_setup_relay "$ROOTFS" "$HOST_PREFIX"
if [ -n "$SANDBOX_PATH_PREPEND" ]; then
  ENV_PATH="$SANDBOX_PATH_PREPEND:$ENV_PATH"
fi

cleanup_relay() {
  termux_sandbox_cleanup_relay
}
trap cleanup_relay EXIT

STORAGE_MASK_DIR="$ROOTFS/tmp/storage-emulated-mask"
case "$STORAGE_MODE" in
  full)
    ;;
  scoped)
    rm -rf "$STORAGE_MASK_DIR"
    mkdir -p "$STORAGE_MASK_DIR"
    while IFS= read -r rel_path; do
      [ -n "$rel_path" ] || continue
      mkdir -p "$STORAGE_MASK_DIR/$rel_path"
    done <<EOF
$STORAGE_PATHS
EOF
    ;;
  none)
    rm -rf "$STORAGE_MASK_DIR"
    mkdir -p "$STORAGE_MASK_DIR"
    ;;
esac

set -- \
  proot \
  --kill-on-exit \
  --link2symlink \
  -b "$ROOTFS":/data/data/com.termux/files/usr \
  -b "$WORKDIR":/data/data/com.termux/files/usr/home/agent/work \
  -b "$ROOTFS/tmp":/tmp \
  -b "$ROOTFS/var/tmp":/var/tmp \
  -b /dev -b /proc -b /sys -b /system -b /apex

case "$STORAGE_MODE" in
  full)
    set -- "$@" -b /storage/emulated:/storage/emulated
    ;;
  scoped)
    set -- "$@" -b "$STORAGE_MASK_DIR":/storage/emulated
    while IFS= read -r rel_path; do
      [ -n "$rel_path" ] || continue
      storage_bind="/storage/emulated/$rel_path"
      set -- "$@" -b "$storage_bind:$storage_bind"
    done <<EOF
$STORAGE_PATHS
EOF
    ;;
  none)
    set -- "$@" -b "$STORAGE_MASK_DIR":/storage/emulated
    ;;
esac

set -- "$@" \
  -w /data/data/com.termux/files/usr/home/agent \
  /data/data/com.termux/files/usr/bin/bash -lc '
    export PREFIX=/data/data/com.termux/files/usr
    export TERMUX_PREFIX=$PREFIX
    export HOME=/data/data/com.termux/files/usr/home/agent
    cd "$HOME/work"
    exec bash --rcfile /data/data/com.termux/files/usr/etc/termux-sandbox-rc'

env -i \
  TERM="$ENV_TERM" \
  HOME=/data/data/com.termux/files/usr/home/agent \
  PREFIX=/data/data/com.termux/files/usr \
  TERMUX_PREFIX=/data/data/com.termux/files/usr \
  TERMUX_SANDBOX_NAME="$SANDBOX_NAME" \
  TERMUX_SANDBOX_PATH_PREPEND="$SANDBOX_PATH_PREPEND" \
  LD_PRELOAD="$ENV_LD_PRELOAD" \
  PATH="$ENV_PATH" \
  "$@"
